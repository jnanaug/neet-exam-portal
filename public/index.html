<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NEET Exam Portal</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <!-- Chart.js for performance analysis -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Removed EmailJS SDK components as per request -->
  <style>
    /* Global Styles */
    body {
      background: linear-gradient(135deg, #74ABE2, #5563DE);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
    }
    /* Fixed nav bar at top */
    nav {
      background: #007BFF;
      padding: 10px 20px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }
    /* Ensure main content starts below nav */
    .main-content {
      padding-top: 60px;
    }
    .container {
      max-width: 900px;
      margin: 50px auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    h2, h3 { text-align: center; color: #333; }
    /* Landing Page */
    #landing { text-align: center; margin-top: 100px; }
    #landing button { padding: 10px 30px; margin: 10px; font-size: 1.1em; cursor: pointer; }
    /* Login/Signup Windows */
    .auth-window { display: none; }
    .auth-window input {
      width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;
      box-sizing: border-box;
    }
    .auth-window button { padding: 10px 15px; border: none; border-radius: 4px; background: #007BFF; color: #fff; cursor: pointer; }
    .auth-window a { color: #007BFF; text-decoration: none; font-size: 0.9em; }
    /* Nav Right (username and logout) */
    .nav-right { position: relative; }
    #accountMenu {
      cursor: pointer;
      padding: 5px;
      display: inline-block;
    }
    /* Set a minimum width for accountName so it shows the actual username */
    #accountName {
      display: inline-block;
      min-width: 80px;
    }
    #dropdownMenu {
      display: none;
      position: absolute;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 120px;
      z-index: 1001;
    }
    #dropdownMenu button {
      width: 100%;
      padding: 8px;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      color: #000;
    }
    #dropdownMenu button:hover { background: #fff; }
    nav button { background: transparent; border: none; color: #fff; font-size: 1em; margin: 0 10px; cursor: pointer; }
    nav button:hover { text-decoration: underline; }
    /* Exam Styles */
    /* The exam container uses flex so that the main exam area and sidebar are shown side by side */
    #exam { display: none; }
    #exam-main { flex: 1; padding-right: 10px; }
    #exam-sidebar {
      width: 150px;
      padding: 10px;
      border-left: 1px solid #ccc;
      overflow-y: auto;
      max-height: 500px;
    }
    .subject-group { margin-bottom: 20px; }
    .subject-group h4 {
      margin: 0 0 5px 0;
      font-size: 1em;
      text-align: center;
    }
    .question-box {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin: 2px;
      border: 1px solid #999;
      text-align: center;
      line-height: 20px;
      font-size: 0.8em;
      cursor: pointer;
      background-color: #f0f0f0;
    }
    /* Highlight active question box with a blue border */
    .question-box.active {
      border: 2px solid blue;
    }
    .question-number {
      font-size: 1.2em;
      font-weight: bold;
      color: #444;
      margin-bottom: 10px;
      text-align: center;
    }
    .question-text { margin: 10px 0; }
    .option { margin: 8px 0; }
    label { margin-left: 8px; }
    #navigation { text-align: center; margin-top: 20px; }
    #timer { font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 1.1em; }
    /* Result & Performance */
    .result-question { margin-bottom: 15px; }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    .unanswered { color: gray; font-weight: bold; }
    hr { border: 0; border-top: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: center; }
    tr:hover { background: #f1f1f1; cursor: pointer; }
    tr.completed { background-color: #e8f5e9 !important; }
    /* Password Strength Meter */
    #strengthMeter { width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin-top: 5px; }
    #strengthBar { height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s; }
    .bookmark-btn {
      background: none;
      border: none;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    /* Outline or gray for NOT bookmarked */
    .bookmark-btn.not-bookmarked {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" stroke="%23000" fill="none" viewBox="0 0 24 24"><path d="M6 2v20l6-6 6 6V2z" stroke-width="2"/></svg>');
    }
    /* Solid black for bookmarked */
    .bookmark-btn.bookmarked {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%23000" viewBox="0 0 24 24"><path d="M6 2v20l6-6 6 6V2z"/></svg>');
    }
  </style>
</head>
<body>
  <div class="main-content">
    <!-- Landing Page -->
    <div id="landing" class="container">
      <h2>Welcome to the NEET Exam Portal</h2>
      <button id="landingLoginBtn">Login</button>
      <button id="landingSignupBtn">Sign Up</button>
    </div>

    <!-- Login Window -->
    <div id="loginWindow" class="container auth-window">
      <h2>Login</h2>
      <div style="text-align: center; margin-bottom: 20px;">
        <button id="googleLoginBtn">Login with Google</button>
      </div>
      <hr>
      <p style="text-align:center;">Or login with username:</p>
      <input type="text" id="loginUsername" placeholder="Username or Gmail" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <div style="text-align:center;">
        <button id="loginBtn">Login</button>
      </div>
      <p style="text-align:center;"><a href="#" id="backToLandingFromLogin">Back</a></p>
    </div>

    <!-- Signup Window -->
    <div id="signupWindow" class="container auth-window">
      <h2>Sign Up</h2>
      <div style="text-align: center; margin-bottom: 20px;">
        <button id="googleSignupBtn">Sign up with Google</button>
      </div>
      <hr>
      <p style="text-align:center;">Or sign up with username:</p>
      <input type="text" id="signupUsername" placeholder="Choose a Username" required>
      <input type="email" id="signupEmail" placeholder="Your Gmail" required>
      <input type="password" id="signupPassword" placeholder="Choose a Password" required>
      <input type="password" id="signupPasswordConfirm" placeholder="Confirm Password" required>
      <div id="strengthMeter">
        <div id="strengthBar"></div>
      </div>
      <div style="text-align:center; margin-top: 10px;">
        <button id="signupBtn">Sign Up</button>
      </div>
      <p style="text-align:center;"><a href="#" id="backToLandingFromSignup">Back</a></p>
    </div>

    <!-- Main UI (After Login) -->
    <div id="mainUI" style="display:none;">
      <nav>
        <div class="nav-left">
          <button id="modelPapersTab">Model Papers</button>
          <button id="performanceTab">Performance Analysis</button>
        </div>
        <div class="nav-right">
          <div id="accountMenu">
            <span id="accountName" style="font-weight: bold;">User</span>
            <div id="dropdownMenu">
              <button id="logoutBtn">Logout</button>
            </div>
          </div>
        </div>
      </nav>
      
      <!-- Model Papers Section -->
      <div id="modelPapers" class="container" style="display:none;">
        <h2>Model Papers</h2>
        <table>
          <thead>
            <tr>
              <th>Paper ID</th>
              <th>Status</th>
              <th>Highest Marks</th>
            </tr>
          </thead>
          <tbody id="papersTableBody">
            <!-- Model paper rows will be inserted here -->
          </tbody>
        </table>
      </div>
      
      <!-- Performance Analysis Section -->
      <div id="performance" class="container" style="display:none;">
        <h2>Performance Analysis</h2>
        <canvas id="performanceChart" width="400" height="200"></canvas>
        <h3>Suggestions</h3>
        <div id="suggestions">
          <!-- Suggestions based on exam performance will appear here -->
        </div>
      </div>
      
      <!-- Exam Interface -->
      <div id="exam" class="container" style="display:none;">
        <div id="exam-main">
          <div id="timer"></div>
          <div id="question-container"></div>
          <div id="navigation" style="text-align:center;">
            <button id="prevBtn" style="display:none;">Previous</button>
            <button id="nextBtn">Next</button>
            <button id="submitBtn">Submit Exam</button>
          </div>
        </div>
        <div id="exam-sidebar">
          <!-- Sidebar with subject question boxes will be generated here -->
        </div>
      </div>
      
      <!-- Result Page -->
      <div id="result" class="container" style="display:none;"></div>
    </div>
  </div>
  
  <script>
    // -------------------------------
    // Firebase Configuration – replace with your own values
    // -------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAUNfNUXwj4Ik7BeubVRGKTkzdiq21gWS8",
      authDomain: "neet-d0b2b.firebaseapp.com",
      projectId: "neet-d0b2b",
      storageBucket: "neet-d0b2b.firebasestorage.app",
      messagingSenderId: "38447232972",
      appId: "1:38447232972:web:355f38d697aace44f54f69",
      measurementId: "G-J8HJR69H3Q"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var provider = new firebase.auth.GoogleAuthProvider();
    
    // Global flag to indicate if exam is submitted
    var examSubmitted = false;
    
    // Check persistent login on page load
    window.onload = function() {
      if(localStorage.getItem("loggedInUser")) {
        showMainUI();
      }
    };
    
    // -------------------------------
    // Landing & Navigation between Auth Windows
    // -------------------------------
    document.getElementById("landingLoginBtn").addEventListener("click", function(){
      document.getElementById("landing").style.display = "none";
      document.getElementById("loginWindow").style.display = "block";
    });
    document.getElementById("landingSignupBtn").addEventListener("click", function(){
      document.getElementById("landing").style.display = "none";
      document.getElementById("signupWindow").style.display = "block";
    });
    document.getElementById("backToLandingFromLogin").addEventListener("click", function(){
      document.getElementById("loginWindow").style.display = "none";
      document.getElementById("landing").style.display = "block";
    });
    document.getElementById("backToLandingFromSignup").addEventListener("click", function(){
      document.getElementById("signupWindow").style.display = "none";
      document.getElementById("landing").style.display = "block";
    });
    
    // Toggle dropdown for account menu
    document.getElementById("accountMenu").addEventListener("click", function(){
      var dropdown = document.getElementById("dropdownMenu");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });
    
    // -------------------------------
    // Google Authentication Functions
    // -------------------------------
    function googleSignup() {
      firebase.auth().signInWithPopup(provider)
        .then(function(result) {
          var user = result.user;
          db.collection("users").doc(user.email).get().then(function(doc) {
            if (doc.exists) {
              alert("This account is already registered. Redirecting to login.");
              document.getElementById("signupWindow").style.display = "none";
              document.getElementById("loginWindow").style.display = "block";
            } else {
              db.collection("users").doc(user.email).set({
                username: user.displayName,
                email: user.email,
                papers: []
              }).then(function() {
                alert("Signup successful! Please login.");
                document.getElementById("signupWindow").style.display = "none";
                document.getElementById("loginWindow").style.display = "block";
              }).catch(function(error) {
                console.error("Error writing document: ", error);
                alert("Error saving user data: " + error.message);
              });
            }
          });
        })
        .catch(function(error) {
          console.error("Google signup error:", error);
          alert("Google signup failed: " + error.message);
        });
    }
    
    function googleLogin() {
      firebase.auth().signInWithPopup(provider)
        .then(function(result) {
          var user = result.user;
          db.collection("users").doc(user.email).get().then(function(doc) {
            if (!doc.exists) {
              alert("This account is not registered. Please sign up first.");
            } else {
              localStorage.setItem("loggedInUser", user.email);
              var name = doc.data().username || "User";
              document.getElementById("accountName").innerText = name;
              showMainUI();
            }
          });
        })
        .catch(function(error) {
          console.error("Google login error:", error);
          alert("Google login failed: " + error.message);
        });
    }
    
    document.getElementById("googleSignupBtn").addEventListener("click", googleSignup);
    document.getElementById("googleLoginBtn").addEventListener("click", googleLogin);
    
    // -------------------------------
    // Username-based Login/Signup using Firestore
    // -------------------------------
    document.getElementById("signupBtn").addEventListener("click", function(){
      var username = document.getElementById("signupUsername").value.trim();
      var email = document.getElementById("signupEmail").value.trim();
      var password = document.getElementById("signupPassword").value;
      var passwordConfirm = document.getElementById("signupPasswordConfirm").value;
      if (!username || !email || !password || !passwordConfirm) {
        alert("Please fill in all fields.");
        return;
      }
      if (password !== passwordConfirm) {
        alert("Passwords do not match.");
        return;
      }
      if (password.length < 6) {
        alert("Password too weak. It must be at least 6 characters long.");
        return;
      }
      db.collection("users").doc(email).get().then(function(doc) {
        if (doc.exists) {
          alert("An account with this Gmail already exists. Redirecting to login.");
          document.getElementById("signupWindow").style.display = "none";
          document.getElementById("loginWindow").style.display = "block";
        } else {
          db.collection("users").doc(email).set({
            username: username,
            email: email,
            password: password, // In production, never store passwords as plain text.
            papers: []
          }).then(function() {
            alert("Signup successful! Please log in.");
            document.getElementById("signupWindow").style.display = "none";
            document.getElementById("loginWindow").style.display = "block";
          }).catch(function(error) {
            alert("Error during signup: " + error.message);
          });
        }
      });
    });
    
    document.getElementById("loginBtn").addEventListener("click", function(){
      var usernameOrEmail = document.getElementById("loginUsername").value.trim();
      var password = document.getElementById("loginPassword").value;
      if (!usernameOrEmail || !password) {
        alert("Please fill in both username/email and password.");
        return;
      }
      db.collection("users").doc(usernameOrEmail).get().then(function(doc) {
        if (doc.exists) {
          var data = doc.data();
          if (data.password !== password) {
            alert("Invalid username/email or password.");
          } else {
            localStorage.setItem("loggedInUser", doc.id);
            var name = data.username || "User";
            document.getElementById("accountName").innerText = name;
            showMainUI();
          }
        } else {
          db.collection("users").where("username", "==", usernameOrEmail).get().then(function(querySnapshot) {
            if (querySnapshot.empty) {
              alert("Invalid username/email or password.");
            } else {
              var userDoc = querySnapshot.docs[0];
              var data = userDoc.data();
              if (data.password !== password) {
                alert("Invalid username/email or password.");
              } else {
                localStorage.setItem("loggedInUser", userDoc.id);
                var name = data.username || "User";
                document.getElementById("accountName").innerText = name;
                showMainUI();
              }
            }
          });
        }
      });
    });
    
    // Logout functionality – manual logout only clears login
    document.getElementById("logoutBtn").addEventListener("click", function(){
      localStorage.removeItem("loggedInUser");
      firebase.auth().signOut().then(function() {
        location.reload();
      }).catch(function(error) {
        console.error("Error during sign out:", error);
      });
    });
    
    // -------------------------------
    // Password Strength Checker
    // -------------------------------
    var signupPassword = document.getElementById("signupPassword");
    var strengthBar = document.getElementById("strengthBar");
    signupPassword.addEventListener("input", function(){
      var val = signupPassword.value;
      var strength = 0;
      if(val.length >= 6) strength += 1;
      if(val.match(/[A-Z]/)) strength += 1;
      if(val.match(/[0-9]/)) strength += 1;
      if(val.match(/[^a-zA-Z0-9]/)) strength += 1;
      var percent = (strength / 4) * 100;
      strengthBar.style.width = percent + "%";
      if(percent < 50) {
        strengthBar.style.background = "red";
      } else if(percent < 75) {
        strengthBar.style.background = "orange";
      } else {
        strengthBar.style.background = "green";
      }
    });
    
    var subjectGroups = {};
    
    function showMainUI() {
      document.body.style.background = "#f5f5f5";
      document.getElementById("landing").style.display = "none";
      document.getElementById("loginWindow").style.display = "none";
      document.getElementById("signupWindow").style.display = "none";
      document.getElementById("mainUI").style.display = "block";
      
      var userEmail = localStorage.getItem("loggedInUser");
      db.collection("users").doc(userEmail).get().then(function(doc) {
        if (doc.exists) {
          var name = doc.data().username || "User";
          document.getElementById("accountName").innerText = name;
          updatePapersTable();
          updatePerformanceAnalysis();
          showSection("modelPapers");
        }
      });
    }
    
    // Warn if exam in progress when switching sections
    document.getElementById("modelPapersTab").addEventListener("click", function(){
      if(examQuestions.length > 0 && !examSubmitted && !confirm("Are you sure you want to leave the test? Your current progress will be lost.")) {
        return;
      }
      examQuestions = [];
      userAnswers = [];
      showSection("modelPapers");
    });
    document.getElementById("performanceTab").addEventListener("click", function(){
      if(examQuestions.length > 0 && !examSubmitted && !confirm("Are you sure you want to leave the test? Your current progress will be lost.")) {
        return;
      }
      examQuestions = [];
      userAnswers = [];
      showSection("performance");
      updatePerformanceAnalysis();
    });
    
    function showSection(sectionId) {
      document.getElementById("modelPapers").style.display = "none";
      document.getElementById("performance").style.display = "none";
      document.getElementById("result").style.display = "none";
      document.getElementById("exam").style.display = "none";
      if(sectionId === "exam") {
        document.getElementById("exam").style.display = "flex";
      } else {
        document.getElementById(sectionId).style.display = "block";
      }
    }
    
    // -------------------------------
    // Exam Logic
    // -------------------------------
    var examQuestions = [];
    var currentQuestionIndex = 0;
    var userAnswers = [];
    var selectedPaper = null;
    var bookmarkedQuestions = [];
    
    function toggleOptionSelection() {
      var options = document.getElementsByName("option");
      options.forEach(option => {
        option.addEventListener("click", function() {
          if (this.checked) {
            if (userAnswers[currentQuestionIndex] === this.value) {
              this.checked = false;
              userAnswers[currentQuestionIndex] = "";
            } else {
              userAnswers[currentQuestionIndex] = this.value;
            }
          }
        });
      });
    }
    
    function showQuestion(index) {
      var container = document.getElementById("question-container");
      var q = examQuestions[index];

      // Check bookmark status
      var isBookmarked = bookmarkedQuestions.includes(index);
      // Choose the appropriate CSS class
      var bookmarkClass = isBookmarked ? "bookmark-btn bookmarked" : "bookmark-btn not-bookmarked";

      container.innerHTML = `
        <div style="position: relative;">
          <div class="question-number">Question ${index + 1} of ${examQuestions.length}</div>
          <button class="${bookmarkClass}" onclick="toggleBookmark(${index})"></button>
        </div>
        <h3>${q.section}</h3>
        <p class="question-text">${q.question}</p>
        <form id="optionForm">
      `;
      
      q.options.forEach(function(option, i) {
        var checked = (userAnswers[index] !== undefined && userAnswers[index].trim() !== "" && userAnswers[index] === option) ? "checked" : "";
        container.innerHTML += `<div class='option'><input type='radio' name='option' id='opt${i}' value='${option}' ${checked}>
                                <label for='opt${i}'>${option}</label></div>`;
      });
      container.innerHTML += "</form>";
      document.getElementById("prevBtn").style.display = (index === 0) ? "none" : "inline";
      document.getElementById("nextBtn").style.display = (index === examQuestions.length - 1) ? "none" : "inline";

      // Add tiny boxes for unanswered, answered, and reviewed questions
      var answeredCount = userAnswers.filter(answer => answer && answer.trim() !== "").length;
      var reviewedCount = bookmarkedQuestions.length;
      var unansweredCount = userAnswers.filter((answer, i) => answer === "" && !bookmarkedQuestions.includes(i)).length;

      container.innerHTML += `
        <div style="position: absolute; top: 10px; left: 10px;">
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
              <div style="width: 20px; height: 20px; background-color: green; color: white; text-align: center; line-height: 20px; border-radius: 3px; font-size: 0.7em;">${answeredCount}</div>
              <span style="margin-left: 5px; font-size: 0.7em;">Answered</span>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
              <div style="width: 20px; height: 20px; background-color: red; color: white; text-align: center; line-height: 20px; border-radius: 3px; font-size: 0.7em;">${unansweredCount}</div>
              <span style="margin-left: 5px; font-size: 0.7em;">Unanswered</span>
            </div>
            <div style="display: flex; align-items: center;">
              <div style="width: 20px; height: 20px; background-color: yellow; color: black; text-align: center; line-height: 20px; border-radius: 3px; font-size: 0.7em;">${reviewedCount}</div>
              <span style="margin-left: 5px; font-size: 0.7em;">Reviewed</span>
            </div>
          </div>
        </div>
      `;

      // Ensure toggleOptionSelection is called after the options are rendered
      toggleOptionSelection();
    }
    
    function toggleBookmark(index) {
      if (bookmarkedQuestions.includes(index)) {
        bookmarkedQuestions = bookmarkedQuestions.filter(i => i !== index);
      } else {
        bookmarkedQuestions.push(index);
      }
      // Re-render the question to update the bookmark icon
      showQuestion(index);
    }
    
    function saveAnswer() {
      var options = document.getElementsByName("option");
      var answered = false;
      for (var i = 0; i < options.length; i++) {
        if (options[i].checked) {
          userAnswers[currentQuestionIndex] = options[i].value;
          answered = true;
        }
      }
      if (!answered) {
        userAnswers[currentQuestionIndex] = "";
      }
    }
    
    document.getElementById("nextBtn").addEventListener("click", function(){
      saveAnswer();
      if (currentQuestionIndex < examQuestions.length - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
        updateSidebar();
      }
    });
    
    document.getElementById("prevBtn").addEventListener("click", function(){
      saveAnswer();
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion(currentQuestionIndex);
        updateSidebar();
      }
    });
    
    function startExam() {
      currentQuestionIndex = 0;
      userAnswers = new Array(examQuestions.length); // Initialize with undefined values
      examSubmitted = false;
      bookmarkedQuestions = [];
      subjectGroups = {};
      
      examQuestions.forEach(function(q, index) {
        var subject = q.section;
        if (!subjectGroups[subject]) {
          subjectGroups[subject] = [];
        }
        subjectGroups[subject].push(index);
      });
      
      showQuestion(currentQuestionIndex);
      updateSidebar();
      startTimer();
    }
    
    var examDuration = 3 * 60 * 60; // 3 hours in seconds
    var timerInterval;
    function startTimer(){
      var timeLeft = examDuration;
      clearInterval(timerInterval);
      timerInterval = setInterval(function(){
        var hours = Math.floor(timeLeft / 3600);
        var minutes = Math.floor((timeLeft % 3600) / 60);
        var seconds = timeLeft % 60;
        document.getElementById("timer").innerText = hours + "h " + minutes + "m " + seconds + "s remaining";
        timeLeft--;
        if (timeLeft < 0) {
          clearInterval(timerInterval);
          alert("Time's up!");
          submitExam();
        }
      }, 1000);
    }
    
    document.getElementById("submitBtn").addEventListener("click", function(){
      if (confirm("Are you sure you want to submit the exam?")) {
        submitExam();
      }
    });
    
    function submitExam() {
      saveAnswer();
      clearInterval(timerInterval);
      examSubmitted = true;

      var score = 0;
      var mistakes = {};
      var resultHTML = "<h2>Exam Results</h2>";

      // Initialize section-wise results
      var sectionResults = {
        Physics: [],
        Chemistry: [],
        Biology: []
      };

      // Calculate the score and mistakes
      for (var i = 0; i < examQuestions.length; i++) {
        var q = examQuestions[i];
        var candidateAnswer = (userAnswers[i] === undefined) ? "" : userAnswers[i];
        var correctAnswer = q.answer;
        if (candidateAnswer === correctAnswer) {
          score += 4; // Correct answer adds 4 marks
        } else {
          if (candidateAnswer !== "") {
            score -= 1; // Wrong answer subtracts 1 mark
          }
          // Record mistake with topic, count and subject (from q.section)
          if (mistakes[q.topic]) {
            mistakes[q.topic].count++;
          } else {
            mistakes[q.topic] = { subject: q.section, count: 1 };
          }
        }

        // Add question result to the appropriate section
        if (!sectionResults[q.section]) {
          sectionResults[q.section] = [];
        }
        sectionResults[q.section].push({
          question: q.question,
          candidateAnswer: candidateAnswer,
          correctAnswer: correctAnswer
        });
      }

      resultHTML += "<h3>Your Total Score: " + score + " out of " + (examQuestions.length * 4) + "</h3>";

      // Add buttons for each section
      resultHTML += `
        <div style="text-align: center; margin-bottom: 20px;">
          <button onclick="showSectionResults('Physics')">Physics</button>
          <button onclick="showSectionResults('Chemistry')">Chemistry</button>
          <button onclick="showSectionResults('Biology')">Biology</button>
        </div>
        <div id="sectionResults"></div>
      `;

      var userEmail = localStorage.getItem("loggedInUser");
      db.collection("users").doc(userEmail).update({
        papers: firebase.firestore.FieldValue.arrayUnion({
          paperId: selectedPaper.paperId,
          score: score,
          total: examQuestions.length * 4,
          mistakes: mistakes,
          date: new Date().toLocaleString(),
          completed: true
        })
      }).then(function() {
        showSection("result");
        document.getElementById("result").innerHTML = resultHTML;
        updatePapersTable();
        updatePerformanceAnalysis();
      }).catch(function(error) {
        alert("Error saving exam result: " + error.message);
      });

      // Function to show results for a specific section
      window.showSectionResults = function(section) {
        var sectionHTML = "<h3>" + section + " Results</h3>";
        var correctCount = 0;
        var incorrectCount = 0;
        var unansweredCount = 0;

        sectionResults[section].forEach(function(res, index) {
          if (res.candidateAnswer === res.correctAnswer) {
            correctCount++;
          } else if (res.candidateAnswer === "") {
            unansweredCount++;
          } else {
            incorrectCount++;
          }

          var answerColor = res.candidateAnswer === "" ? "gray" : (res.candidateAnswer === res.correctAnswer ? "green" : "red");

          sectionHTML += "<div class='result-question'>";
          sectionHTML += "<div class='question-number'>Question " + (index + 1) + ":</div>";
          sectionHTML += "<div class='question-text'>" + res.question + "</div>";
          sectionHTML += "<div class='candidate-answer'><strong>Your Answer:</strong> <span style='color: " + answerColor + ";'>" + (res.candidateAnswer === "" ? "No answer" : res.candidateAnswer) + "</span></div>";
          sectionHTML += "<div class='correct-answer'><strong>Correct Answer:</strong> " + res.correctAnswer + "</div>";
          sectionHTML += "</div><hr>";
        });

        // Add correct, incorrect, and unanswered counts as tiny boxes
        sectionHTML = `
          <div style="position: relative;">
            <div style="position: absolute; top: 10px; right: 10px;">
              <div style="display: inline-block; width: 20px; height: 20px; background-color: green; color: white; text-align: center; line-height: 20px; border-radius: 3px;">${correctCount}</div>
              <div style="display: inline-block; width: 20px; height: 20px; background-color: red; color: white; text-align: center; line-height: 20px; border-radius: 3px; margin-left: 5px;">${incorrectCount}</div>
              <div style="display: inline-block; width: 20px; height: 20px; background-color: gray; color: white; text-align: center; line-height: 20px; border-radius: 3px; margin-left: 5px;">${unansweredCount}</div>
            </div>
          </div>
        ` + sectionHTML;

        document.getElementById("sectionResults").innerHTML = sectionHTML;
      };
    }
    
    // Function to update the sidebar with subject question boxes
    function updateSidebar() {
      var sidebar = document.getElementById("exam-sidebar");
      sidebar.innerHTML = "";
      for (var subject in subjectGroups) {
        var groupDiv = document.createElement("div");
        groupDiv.className = "subject-group";
        var subjectHeader = document.createElement("h4");
        subjectHeader.innerText = subject;
        groupDiv.appendChild(subjectHeader);
        var indices = subjectGroups[subject];
        indices.forEach(function(qIndex, i) {
          var box = document.createElement("div");
          box.className = "question-box";
          if (parseInt(qIndex) === currentQuestionIndex) {
            box.classList.add("active");
          }
          box.innerText = (i + 1);
          box.dataset.qIndex = qIndex;
          if (bookmarkedQuestions.includes(qIndex)) {
            box.style.backgroundColor = "yellow"; // yellow for bookmarked
          } else if (userAnswers[qIndex] !== undefined) {
            if (userAnswers[qIndex].trim() !== "") {
              box.style.backgroundColor = "#90EE90"; // light green for answered
            } else {
              box.style.backgroundColor = "#ffcccb"; // light red for skipped
            }
          } else {
            box.style.backgroundColor = "#f0f0f0"; // default for not yet visited
          }
          box.addEventListener("click", function(){
            currentQuestionIndex = parseInt(this.dataset.qIndex);
            showQuestion(currentQuestionIndex);
          });
          groupDiv.appendChild(box);
        });
        sidebar.appendChild(groupDiv);
      }
    }
    
    // Update Model Papers table with highest marks for each paper.
    function updatePapersTable() {
      var userEmail = localStorage.getItem("loggedInUser");
      db.collection("users").doc(userEmail).get().then(function(doc) {
        if (doc.exists) {
          var userRecord = doc.data();
          var tbody = document.getElementById("papersTableBody");
          tbody.innerHTML = "";
          modelPapers.forEach(function(paper) {
            var row = document.createElement("tr");
            var attempts = (userRecord.papers || []).filter(p => p.paperId === paper.paperId);
            var status = attempts.length > 0 && attempts.some(a => a.completed) ? "Completed" : "Not Attempted";
            var marks = "-";
            if(attempts.length > 0) {
              var highestScore = Math.max(...attempts.map(a => a.score));
              var totalMarks = paper.questions.length * 4; // Calculate total marks based on number of questions
              marks = highestScore + " / " + totalMarks;
              if(status === "Completed") {
                row.classList.add('completed');
              }
            }
            row.innerHTML = "<td>" + paper.paperId + "</td>" +
                            "<td>" + status + "</td>" +
                            "<td>" + marks + "</td>";
            row.addEventListener("click", function(){
              if(examQuestions.length > 0 && !examSubmitted && !confirm("Are you sure you want to start a new test? Your current progress will be lost.")) {
                return;
              }
              if (confirm("Are you sure you want to start the exam?")) {
                selectedPaper = paper;
                examQuestions = paper.questions;
                currentQuestionIndex = 0;
                userAnswers = [];
                examSubmitted = false;
                showSection("exam");
                startExam();
              }
            });
            tbody.appendChild(row);
          });
        }
      });
    }
    
    function updatePerformanceAnalysis() {
      var userEmail = localStorage.getItem("loggedInUser");
      db.collection("users").doc(userEmail).get().then(function(doc) {
        if (!doc.exists) {
          document.getElementById("suggestions").innerHTML = "<p>No exam data available.</p>";
          return;
        }
        var userRecord = doc.data();

        console.log("User Record from Firestore:", userRecord); // Log the entire user record for debugging

        if (window.performanceChart && typeof window.performanceChart.destroy === "function") {
          window.performanceChart.destroy();
        }
        var labels = [];
        var dataArr = [];
        var tooltips = [];
        var suggestions = [];

        if (userRecord.papers) {
          userRecord.papers.forEach(function(p) {
            console.log("Processing paper:", p.paperId, "Questions:", p.questions); // Log each paper and its questions

            labels.push(p.paperId + " (" + p.date + ")");
            // Use a placeholder for zero scores to ensure visibility
            dataArr.push(p.score === 0 ? 0.4 : p.score);

            // Prepare tooltip content
            tooltips.push("Score: " + p.score);

            // Prepare suggestions content
            var suggestionContent = "<h5>" + p.paperId + " (" + p.date + ")</h5>";
            var sectionMistakes = { Physics: {}, Chemistry: {}, Biology: {} };

            // Fetch mistakes from Firestore
            if (p.mistakes && Object.keys(p.mistakes).length > 0) {
              Object.entries(p.mistakes).forEach(function([topic, mistakeObj]) {
                // Here, mistakeObj has the structure: { subject: "Physics", count: <number> }
                let section = mistakeObj.subject; 
                let count = mistakeObj.count;
                if (section && sectionMistakes[section]) {
                  sectionMistakes[section][topic] = (sectionMistakes[section][topic] || 0) + count;
                }
              });

              suggestionContent += '<div class="suggestions-container" style="display: flex; justify-content: space-between;">';
              ["Physics", "Chemistry", "Biology"].forEach(function(subject) {
                suggestionContent += `<div class="suggestions-column" id="${subject.toLowerCase()}-suggestions"><h3>${subject}</h3><ul>`;
                Object.entries(sectionMistakes[subject]).forEach(function([topic, count]) {
                  suggestionContent += `<li><strong>${topic}:</strong> ${count} mistake(s)</li>`;
                });
                suggestionContent += "</ul></div>";
              });
              suggestionContent += "</div>";
            } else {
              suggestionContent += "<p>No mistakes recorded. Great job!</p>";
            }
            suggestions.push(suggestionContent);
          });
        }

        var ctx = document.getElementById("performanceChart").getContext("2d");
        window.performanceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Score',
              data: dataArr,
              backgroundColor: 'rgba(0, 123, 255, 0.6)'
            }]
          },
          options: {
            scales: { 
              y: { beginAtZero: true },
              x: { minBarLength: 5 } // Ensure bars with zero scores are visible
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    // Show the actual score in the tooltip
                    return "Score: " + userRecord.papers[context.dataIndex].score;
                  }
                }
              }
            },
            onClick: function(evt, elements) {
              if (elements.length > 0) {
                var index = elements[0].index;
                document.getElementById("suggestions").innerHTML = suggestions[index];
              }
            }
          }
        });
      });
    }
  
  </script>
<script src="questions.js"></script>
</body>
</html>
